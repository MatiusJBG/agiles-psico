@page "/hotels"
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using Application.Interfaces
@using Core.Entities

@attribute [Authorize]

@inject IHotelService HotelService
@inject IReservationService ReservationService
@inject NavigationManager NavigationManager

<link href="css/hotels.css" rel="stylesheet" />

<PageTitle>Hoteles</PageTitle>

<div class="container mt-4">
    <h1 class="page-title">Hoteles Disponibles en Ambato</h1>
    <p class="page-subtitle">Aquí tienes una lista de algunos de los mejores hoteles en Ambato, Tungurahua, Ecuador.</p>
    
    <div class="row mt-4">
        @foreach (var hotel in hoteles)
        {
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 hotel-card" @onclick="() => NavigateToHotel(hotel.Id)">
                    <div id="carousel-@hotel.Id" class="carousel slide" data-bs-ride="carousel" data-bs-interval="3000">
                        <div class="carousel-inner">
                            @for (int i = 0; i < hotel.Images.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@hotel.Images[i]" class="d-block w-100" alt="Imagen de @hotel.Name">
                                </div>
                            }
                        </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#carousel-@hotel.Id" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#carousel-@hotel.Id" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="card-body d-flex flex-column">
                        <div class="hotel-header">
                            <h5 class="card-title">@hotel.Name</h5>
                            <div class="hotel-rating">
                                @for (int i = 0; i < 4; i++)
                                {
                                    <i class="fas fa-star @(i < hotel.StarRating ? "star-filled" : "star-empty")"></i>
                                }
                                <span class="rating-text">@hotel.StarRating estrellas</span>
                            </div>
                        </div>
                        <div class="hotel-price">
                            <span class="price-label">Desde</span>
                            <span class="price-amount">$@hotel.PricePerNight.ToString("N0")</span>
                            <span class="price-period">/noche</span>
                        </div>
                        <p class="card-text">@hotel.Description</p>
                        <div class="hotel-actions">
                            <button class="btn btn-primary reservation-button" @onclick:stopPropagation="true" @onclick="() => OpenReservationModal(hotel)">
                                <i class="fas fa-calendar-plus"></i>
                                <span>Reservar</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@if (showReservationModal)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Reservar en @selectedHotel!.Name</h5>
                    <button type="button" class="btn-close" @onclick="CloseReservationModal"></button>
                </div>
                <div class="modal-body">
                    <div class="hotel-info">
                        <h6><strong>Hotel:</strong> @selectedHotel!.Name</h6>
                        <div class="hotel-rating-modal">
                            @for (int i = 0; i < 4; i++)
                            {
                                <i class="fas fa-star @(i < selectedHotel!.StarRating ? "star-filled" : "star-empty")"></i>
                            }
                            <span>@selectedHotel!.StarRating estrellas</span>
                        </div>
                        <p class="hotel-price-modal">
                            <strong>Precio por noche:</strong> $@selectedHotel!.PricePerNight.ToString("N0")
                        </p>
                    </div>
                    <div class="reservation-form">
                        <div class="form-group">
                            <label for="checkin-date">Fecha de Check-in:</label>
                            <input type="date" id="checkin-date" class="form-control" @bind="checkInDate" />
                        </div>
                        <div class="form-group mt-3">
                            <label for="checkout-date">Fecha de Check-out:</label>
                            <input type="date" id="checkout-date" class="form-control" @bind="checkOutDate" />
                        </div>
                        <div class="form-group mt-3">
                            <label for="num-guests">Número de Huéspedes:</label>
                            <input type="number" id="num-guests" class="form-control" min="1" @bind="guestCount" />
                        </div>
                        @if (checkInDate.HasValue && checkOutDate.HasValue && checkOutDate > checkInDate)
                        {
                            <div class="price-summary mt-3">
                                <div class="summary-row">
                                    <span>Noches:</span>
                                    <span>@GetNightsCount()</span>
                                </div>
                                <div class="summary-row">
                                    <span>Precio por noche:</span>
                                    <span>$@selectedHotel!.PricePerNight.ToString("N0")</span>
                                </div>
                                <div class="summary-row total">
                                    <span><strong>Total:</strong></span>
                                    <span><strong>$@GetTotalPrice().ToString("N0")</strong></span>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseReservationModal">Cancelar</button>
                    <button type="button" class="btn btn-primary reservation-button" @onclick="ConfirmReservation">
                        <span>Confirmar Reserva</span>
                        <i class="fas fa-check"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@if (showSuccess)
{
    <div class="modal-backdrop show"></div>
    <div class="modal show" tabindex="-1" style="display: block;">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">¡Reserva confirmada!</h5>
                    <button type="button" class="btn-close" @onclick="CloseSuccessModal"></button>
                </div>
                <div class="modal-body">
                    <p>Tu reservación en <strong>@selectedHotel?.Name</strong> ha sido registrada exitosamente.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" @onclick="CloseSuccessModal">Entendido</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<Hotel> hoteles = new List<Hotel>();

    protected override void OnInitialized()
    {
        hoteles = HotelService.GetAllHotels();
    }

    private Hotel? selectedHotel;
    private bool showReservationModal = false;
    private DateTime? checkInDate;
    private DateTime? checkOutDate;
    private int guestCount = 1;

    private void OpenReservationModal(Hotel hotel)
    {
        selectedHotel = hotel;
        showReservationModal = true;
        checkInDate = null;
        checkOutDate = null;
        guestCount = 1;
    }

    private void CloseReservationModal()
    {
        showReservationModal = false;
    }

    private void ConfirmReservation()
    {
        if (selectedHotel != null && checkInDate.HasValue && checkOutDate.HasValue)
        {
            var reservation = new Reservation
            {
                UserId = "current-user", 
                HotelId = selectedHotel.Id,
                HotelName = selectedHotel.Name,
                CheckInDate = checkInDate.Value,
                CheckOutDate = checkOutDate.Value,
                GuestCount = guestCount,
                TotalPrice = GetTotalPrice()
            };

            ReservationService.AddReservation(reservation);
            CloseReservationModal();
            ShowSuccessModal();
            
            // Mostrar mensaje de confirmación 
            // En una aplicación real, podrías usar un toast o modal de confirmación
        }
    }

    private bool showSuccess = false;
    private void ShowSuccessModal()
    {
        showSuccess = true;
        StateHasChanged();
    }
    private void CloseSuccessModal() => showSuccess = false;

    private int GetNightsCount()
    {
        if (checkInDate.HasValue && checkOutDate.HasValue)
        {
            return (int)(checkOutDate.Value - checkInDate.Value).TotalDays;
        }
        return 0;
    }

    private decimal GetTotalPrice()
    {
        if (selectedHotel != null && checkInDate.HasValue && checkOutDate.HasValue)
        {
            return selectedHotel.PricePerNight * GetNightsCount();
        }
        return 0;
    }

    private void NavigateToHotel(string hotelId)
    {
        NavigationManager.NavigateTo($"/hotel/{hotelId}");
    }
}